---
title: "u_f_fits"
output: html_document
date: "`r Sys.Date()`"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
library(here)
source(here("base","src.R"))

library(ggnewscale)
```


# Notes

 - this version uses the best fitting f and tries to estiamte u under different formulations
 - each version should use the same u formulation from model 6c which is the full model with an exponential interaction term for the effect of temperature on the resource effect
 - we estimate u as a function of spores consumed
    - so I model dynamics once to figure out how many spores each treatment consumes and use that to estimate the probability of infection we observed
 - as of now, a per-temperature resource-dependent model appears to be the best fitting
 
# things to do
 - effects of temp on u are still wonky. this may just be a units issue
 

# Read data and set global params

```{r}
fitness <- read.csv(here("raw_data/main_fitness_edit.csv")) #must be read.csv
fitness %<>% dplyr::select(tube, temp_id, REMOVED, KBP, final_date)
mort <-  read_csv(here("raw_data/main_mort_edit.csv"))
lengths <- read_csv(here("raw_data", "day5_length.csv")) #from life table
lengths %<>% filter(temp_id %in% c(15,20,25))


dataset <- left_join(mort,fitness) #life table data

data <- readRDS(here("processed_data","foraging_raw.rds")) #foraging rate assay
data_summ <- readRDS(here("processed_data", "foraging.rds")) #foraging rate assay summary

data %<>% mutate(treatment_ID = paste(temp, resource, sep = "_"))

data %<>% mutate(resource_tot = resource*vol) #resource_tot is the total amount of resources in our tube. resource concentration * total volume of tube 

treatment_IDs <- unique(data$treatment_ID)
resource_IDs <- unique(data$resource)
temp_IDs <- unique(data$temp)


fora_vol <- 15 #mL
life_vol <- 50 #mL
spore_conc <- 200 #spores/mL
gamma <- 2 
ref_t <- 15 #celsius

```

Dataset are the data from the life table experiment
Requires a bit of cleaning
```{r}
dataset %<>% filter(species == "D") %>% #only daphnia for this analysis
  filter(temp %in% const_temp) #only constant temp for this analysis

dataset %<>% mutate(birthdate = ifelse(species == "daphnia", "4/5/22", "4/6/22"), 
                    lifespan = as.numeric(mdy(final_date) - mdy(birthdate)),
                    temp = as.numeric(temp),
                    treatment = paste(temp, resource, sep = "_")) %>% 
  filter(is.na(male)) %>% #remove males
  filter(is.na(missing)) %>% #remove missing
  filter(!is.na(inf)) #remove NAs for inf for estimating beta. sometimes they died too young to tell

dataset %<>% mutate(inf_status = inf, dead = ifelse(is.na(REMOVED) & is.na(KBP), 1, 0))


dataset %<>% mutate(spore_exposure = 200, #spores/mL
                    uninf = 1-inf_status,
                    time = 1, #duration of exposure in days
                    trt = paste(temp, resource, species, sep = "_"))
```

We use average lengths later on. We need to use averages because we weren't able to measure length for every individual.
For the foraging rate assay, these are the actual lengths because we measured the length of each individual at the end of the assay.

For the life table data, these are the lengths of a representative number of individuals right before the rest were exposed to spores. We take an average for these lengths since we didn't have length data for every individual.

```{r}
lengths %<>% mutate(mm = raw_meas*17.86/1000)
#at default magnification (5.6x), 1 unit is equal to 17.86 micron

length_summ <- lengths %>% 
  group_by(temp_id, resource) %>% 
  summarize(life_mm = mean(mm),
            var = var(mm),
            sd = sd(mm),
            se = sd(mm)/sqrt(n())) %>%
  ungroup() %>%
  dplyr::select(temp_id, resource, life_mm)

length_summ %<>% add_row(temp_id=as.character(25), resource=as.numeric(0.5), life_mm=1.16) #midpoint between 1.0 and 0.1
```

Join length data to both dataframes
Some of the length data from the foraging rate assay are missing so we impute these values from the averages from the data we do have.
We were also missing length data for one treatment from the life table so we use the foraging rate data lengths to replace those as well.

```{r}
dataset %<>% left_join(length_summ)

length_summ %<>% mutate(ID = paste(temp_id, resource, sep="_")) %>% dplyr::select(-c(temp_id, resource))


mean_length_summ <- data_summ %>% dplyr::select(temp, resource, mm_mean)
data %<>% left_join(., mean_length_summ)
data %<>% mutate(mm = if_else(!is.na(mm), mm, mm_mean))

mean_length_summ %<>% rename(fora_mm = "mm_mean")
dataset %<>% left_join(., mean_length_summ)
```


```{r}
#generated from here("model_fitting", "foraging", "best_fit_f.Rmd")
best_f <- readRDS(here("mle","update","best_f_fit.rds")) # full model with exponential effect of temp on handling time

best_f_coef <- coef(best_f)

f_est <- best_f_coef[1] #ml/day
arr_f_est <- best_f_coef[2] #Celsius
h_est <- best_f_coef[3] #mg dry weight carbon/day
#h is a huge number because it is milligrams carbon/day but daphnia are eating micrograms per day
w_est <- best_f_coef[4] #per-degree Celsius (i.e. 1/Celsius)
```




# Independent Model

This model assumes constant f and constant u for all treatments

$$
\frac{dR}{dt} = -L^{\gamma} fRS\\
$$

We end up using this system of equations for everything and modify it by modifying how parameters are written out in the solver chunk.

This version allows for fractional movements of S to I and implicitly scales per-spore susceptibility by this fraction. i.e. as S becomes smaller, the movement of S to I also decreases because the amount of susceptibles decreases
```{r}
m1_num_sol <- function(t, x, params){
  R <- x[1]
  S <- x[2]
  I <- x[3]
  Z <- x[4]
  with(as.list(params),{
    dR <- -f*R*(S+I)
    dS <- -u*f*Z*S
    dI <- u*f*Z*S
    dZ <- -f*Z*(S+I)
    res <- c(dR, dS, dI, dZ)
    list(res)}
    )
}
```

This version implies that the movement from S to I does not depend on the number of susceptibles remaining. In this scenario, the probability of infection = per-spore susceptibility * number of spores consumed
```{r}
m1_num_sol_alt <- function(t, x, params){
  R <- x[1]
  S <- x[2]
  I <- x[3]
  Z <- x[4]
  with(as.list(params),{
    dR <- -f*R*(S+I)
    dS <- -u*f*Z*(S+I)
    dI <- u*f*Z*(S+I)
    dZ <- -f*Z*(S+I)
    res <- c(dR, dS, dI, dZ)
    list(res)}
    )
}
```





```{r}
m1_sim <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u)
  
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  
  
  end_data <- slice_max(output, time)[,4]

  
  #end_data <- slice_min(output, time)[,5] - slice_max(output, time)[,5] # spores consumed

  return(end_data)
}
```

```{r}
m1_sim_alt <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u)
  
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol_alt, params))
  
  end_data <- slice_max(output, time)[,4]

  
  #end_data <- slice_min(output, time)[,5] - slice_max(output, time)[,5] # spores consumed

  return(end_data)
}
```


```{r}
m1_sim_Z <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u)
  
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  
  end_data <- slice_min(output, time)[,5] - slice_max(output, time)[,5] # spores consumed
  
  return(end_data)
}
```



```{r}

exp_data <- dataset %>% filter(exposed==TRUE)

exp_data %<>% mutate(spores_consumed = mapply(m1_sim_Z,
                                              R = resource*life_vol/1000,
                                              time = 1,
                                              f = f_est/life_vol,
                                              u = 0.0001,
                                              length = life_mm,
                                              gamma = gamma,
                                              Z = spore_conc*life_vol,
                                              ref_t = ref_t,
                                              arr_t_f = arr_f_est,
                                              h = h_est*exp(temp*w_est),
                                              temp = temp))

prob_I <- exp_data$spores_consumed*0.0001


I_end <- as.data.frame(mapply(m1_sim,
                              R=exp_data$resource*life_vol/1000,
                              time=exp_data$time,
                              f=f_est/life_vol,
                              u=0.0001,
                              length = exp_data$life_mm,
                              gamma=gamma,
                              Z=spore_conc*life_vol,
                              ref_t = ref_t,
                              arr_t_f = arr_f_est,
                              h = h_est*exp(exp_data$temp*w_est),
                              temp=exp_data$temp))


I_end_alt <- as.data.frame(mapply(m1_sim_alt,
                              R=exp_data$resource*life_vol/1000,
                              time=exp_data$time,
                              f=f_est/life_vol,
                              u=0.0001,
                              length = exp_data$life_mm,
                              gamma=gamma,
                              Z=spore_conc*life_vol,
                              ref_t = ref_t,
                              arr_t_f = arr_f_est,
                              h = h_est*exp(exp_data$temp*w_est),
                              temp=exp_data$temp))

```


```{r}
exp_data %>% group_by(treatment) %>% dplyr::select(treatment, resource, temp, spores_consumed) %>% distinct() %>% 
  ggplot(.,aes(x=resource, y=spores_consumed, color=as.factor(temp))) + geom_point()
```


If we can use this form of u, then we can more easily write negative log-likelihood functions to represent the effects of variables on u and have it run much faster.

This function returns the log-likelihood from a bernoulli trial
```{r}
inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
```

We'll use this function to measure AIC of our models
```{r}
getAIC <- function(model){
  return(2*length(coef(model))-(2*summary(model)@m2logL/-2))
}
```

This function generates the sum of the negative log-likelihood for all individuals assuming u is a constant across all conditions
```{r}
m1_ll <- function(u){

  exp_data %<>% mutate(I_end = spores_consumed*u)
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()

m1_u_fit <- mle2(m1_ll, start=list(u = 0.0001), 
                     control=list(parscale = c(u = 0.0001)),
                     skip.hessian=F, method="Nelder-Mead")

end_time <- Sys.time()
m1_runtime <- end_time - start_time
m1_runtime

coef(m1_u_fit)

getAIC(m1_u_fit)

saveRDS(m1_u_fit, file = here("mle","susc","m1_u_fit_alt.rds"))
```



# Temperature-Dependent Model

First, we look at temperature effects by fitting a single u for each temperature regardless of resources
```{r}
m2u_ll <- function(u){

  iter_data %<>% mutate(I_end = spores_consumed*u)
  
  iter_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(iter_data$ll)
  
  print(u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
m2_u_fits <- list()

u_vec <- c(0.000001,#pass
           0.000001,#pass
           0.0001)#pass

#for(i in 1:length(resource_IDs))
  
  iter_data <- exp_data %>% filter(temp == temp_IDs[1])
  m2_u_fits[1] <- mle2(m2u_ll, start=list(u = u_vec[1]), 
                     control=list(parscale = c(u = u_vec[1])),
                     skip.hessian=F, method="L-BFGS-B"
                     ,
                     lower=c(u = 0),
                     upper=c(u = 1/6608.229))
  
  iter_data <- exp_data %>% filter(temp == temp_IDs[2])
  m2_u_fits[2] <- mle2(m2u_ll, start=list(u = u_vec[2]),
                   control=list(parscale = c(u = u_vec[2])),
                   skip.hessian=F, method="L-BFGS-B"
                   ,
                   lower=c(u = 0),
                   upper=c(u = 1/6980.857))
  
  iter_data <- exp_data %>% filter(temp == temp_IDs[3])
  m2_u_fits[3] <- mle2(m2u_ll, start=list(u = u_vec[3]), 
                 control=list(parscale = c(u = u_vec[3])),
                 skip.hessian=F, method="L-BFGS-B"
                   ,
                   lower=c(u = 0),
                   upper=c(u = 1/6980.857))
                 


end_time <- Sys.time()
m2_runtime <- end_time - start_time
m2_runtime

getAIC(m2_u_fits[[1]]) + getAIC(m2_u_fits[[2]]) + getAIC(m2_u_fits[[3]])

saveRDS(m2_u_fits, file = here("mle","susc","m2_u_fits_alt.rds"))
```


Next, we'll incorporate effects of temperature by interpreting u as a function of temperature according to this form of the Arrhenius equation

$$
proportion\ infected = spores\ consumed \cdot ue^{T_{A}(1/T_{R}-1/T)} \\
$$


Testing area
```{r, eval=F}
u <- 0.00000001
arr_t_u <- 300

  exp_data %<>% mutate(I_end = spores_consumed*u*exp(arr_t_u*(1/ref_t - 1/temp)))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
print(nll_sum)
```


This is the negative log-likelihood function for this version
```{r}
m2_ll <- function(u, arr_t_u){
  
  exp_data %<>% mutate(I_end = spores_consumed*u*exp(arr_t_u*(1/ref_t - 1/temp)))

  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m2_u_fit <- mle2(m2_ll, start=list(u = 0.00001,
                                   arr_t_u = 10),
                     control=list(parscale = c(u = 0.00001,
                                   arr_t_u = 10)),
                     skip.hessian=F, method="Nelder-Mead")

# m2_u_fit <- mle2(m2_ll, start=list(u = 0.00001,
#                                    arr_t_u = 10),
#                      control=list(parscale = c(u = 0.0001,
#                                    arr_t_u = 10)),
#                      skip.hessian=F, method="L-BFGS-B",
#                  lower=c(u = 0, arr_t_u = 0),
#                  upper=c(u = 1, arr_t_u = Inf))

end_time <- Sys.time()
m2_runtime <- end_time - start_time
m2_runtime

coef(m2_u_fit)

getAIC(m2_u_fit)

saveRDS(m2_u_fit, file = here("mle","susc","m2_u_fit_alt.rds"))
```


# check this!!!
test different starting params. We do get different results for these since they can generate similar products?

```{r, eval=FALSE}
m2_u_fit <- mle2(m2_ll, start=list(u = 0.00001,
                                   arr_t_u = 10),
                     control=list(parscale = c(u = 0.00001,
                                   arr_t_u = 10)),
                     skip.hessian=F, method="BFGS")

m2_u_fita <- mle2(m2_ll, start=list(u = 0.000001,
                                   arr_t_u = 100),
                     control=list(parscale = c(u = 0.000001,
                                   arr_t_u = 100)),
                     skip.hessian=F, method="BFGS")
```


We'll do this again but we'll estimate the Arrhenius temperature for each resource treatment

```{r, eval=F}
start_time <- Sys.time()
m2_u_arr_fits <- list()

u_vec <- c(0.0000001,#pass
           0.00003,#pass
           0.00000001)#pass

#for(i in 1:length(resource_IDs))
  
  iter_data <- exp_data %>% filter(resource == resource_IDs[1])
  m2_u_arr_fits[[1]] <- mle2(m2_ll, start=list(u = u_vec[1],
                                   arr_t_u = 10),
                     control=list(parscale = c(u = u_vec[1],
                                   arr_t_u = 1)),
                     skip.hessian=F, method="BFGS")

    iter_data <- exp_data %>% filter(resource == resource_IDs[2])
  m2_u_arr_fits[[2]] <- mle2(m2_ll, start=list(u = u_vec[2],
                                   arr_t_u = 66),
                     control=list(parscale = c(u = u_vec[2],
                                   arr_t_u = 1)),
                     skip.hessian=F, method="BFGS")
  
    iter_data <- exp_data %>% filter(resource == resource_IDs[3])
  m2_u_arr_fits[[3]] <- mle2(m2_ll, start=list(u = u_vec[3],
                                   arr_t_u = 10),
                     control=list(parscale = c(u = u_vec[3],
                                   arr_t_u = 1)),
                     skip.hessian=F, method="BFGS")
                 


end_time <- Sys.time()
m2_runtime <- end_time - start_time
m2_runtime

getAIC(m2_u_arr_fits[[1]]) + getAIC(m2_u_arr_fits[[2]]) + getAIC(m2_u_arr_fits[[3]])

saveRDS(m2_u_arr_fits, file = here("mle","susc","m2_u_arr_fits_alt.rds"))
```


Finally, we'll try another way of incorporating temperature effects by using an exponential function of temperature to alter u according to temperature.

```{r}
m2a_ll <- function(u, phi){
  
  exp_data %<>% mutate(I_end = spores_consumed*u*exp(phi*temp))

  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(phi)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m2a_u_fit <- mle2(m2a_ll, start=list(u = 0.000001,
                                   phi = 0.1),
                     control=list(parscale = c(u = 0.000001,
                                   phi = 0.1)),
                     skip.hessian=F, method="Nelder-Mead")

# m2_u_fit <- mle2(m2_ll, start=list(u = 0.00001,
#                                    arr_t_u = 10),
#                      control=list(parscale = c(u = 0.0001,
#                                    arr_t_u = 10)),
#                      skip.hessian=F, method="L-BFGS-B",
#                  lower=c(u = 0, arr_t_u = 0),
#                  upper=c(u = 1, arr_t_u = Inf))

end_time <- Sys.time()
m2_runtime <- end_time - start_time
m2_runtime

coef(m2a_u_fit)

getAIC(m2a_u_fit)

saveRDS(m2a_u_fit, file = here("mle","susc","m2a_u_fit_alt.rds"))
```





# Resource-dependent Model

Now we incorporate resource effects assuming a type-II functional response

$$
proportion\ infected = spores\ consumed \cdot u e^{R\rho}\\
$$

We'll start by estimating a separate u for each resource treatment that is constant over temperature conditions.
```{r}
m3u_ll <- function(u){

  iter_data %<>% mutate(I_end = spores_consumed*u)
  
  iter_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(iter_data$ll)
  
  print(u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
m3_u_fits <- list()

u_vec <- c(0.000001,#fail
           0.000001,#fail
           0.0001)#pass

#for(i in 1:length(resource_IDs))
  
  iter_data <- exp_data %>% filter(resource == resource_IDs[1])
  m3_u_fits[1] <- mle2(m3u_ll, start=list(u = u_vec[1]), 
                     control=list(parscale = c(u = u_vec[1])),
                     skip.hessian=F, method="L-BFGS-B"
                     ,
                     lower=c(u = 0),
                     upper=c(u = 1/6608.229))
  
  iter_data <- exp_data %>% filter(resource == resource_IDs[2])
  m3_u_fits[2] <- mle2(m3u_ll, start=list(u = u_vec[2]),
                   control=list(parscale = c(u = u_vec[2])),
                   skip.hessian=F, method="L-BFGS-B"
                   ,
                   lower=c(u = 0),
                   upper=c(u = 1/6980.857))
  
  iter_data <- exp_data %>% filter(resource == resource_IDs[3])
  m3_u_fits[3] <- mle2(m3u_ll, start=list(u = u_vec[3]), 
                 control=list(parscale = c(u = u_vec[3])),
                 skip.hessian=F, method="BFGS")
                 


end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

saveRDS(m3_u_fits, file = here("mle","susc","m3_u_fits_alt.rds"))
```


Next, we'll try modeling u as an exponential function of *initial* resource conditions

testing area
```{r, eval=F}
u <- 0.00001
rho <- 10

  exp_data %<>% mutate(I_end = spores_consumed*u*exp(resource*rho))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(rho)
```

```{r}
m3_rho_ll <- function(u, rho){

  exp_data <- tmp
  
  exp_data %<>% mutate(I_end = spores_consumed*u*exp(resource*rho))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(rho)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- exp_data
m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.0001,
                                   rho = -0.1), 
                     control=list(parscale = c(u = 0.0001,
                                   rho = -0.1)),
                     skip.hessian=F, method="Nelder-Mead")

# m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.000001,
#                                    rho = 0.05), 
#                      control=list(parscale = c(u = 0.000001,
#                                    rho = 0.05)),
#                      skip.hessian=F, method="L-BFGS-B", 
#                  lower=c(u = 0, rho = -Inf), 
#                  upper=c(u = 1, rho = Inf))
end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

coef(m3_u_exp_fit)

getAIC(m3_u_exp_fit)

saveRDS(m3_u_exp_fit, file = here("mle","susc","m3_u_exp_fit_alt.rds"))
```


Next, we'll try this again but get different estimates for each temperature condition


```{r, eval=F}
start_time <- Sys.time()
tmp <- exp_data %>% filter(temp %in% temp_IDs[1])
m3_u_exp_fit_15 <- mle2(m3_rho_ll, start=list(u = 0.0001,
                                   rho = -0.1), 
                     control=list(parscale = c(u = 0.0001,
                                   rho = -0.1)),
                     skip.hessian=F, method="Nelder-Mead")

# m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.000001,
#                                    rho = 0.05), 
#                      control=list(parscale = c(u = 0.000001,
#                                    rho = 0.05)),
#                      skip.hessian=F, method="L-BFGS-B", 
#                  lower=c(u = 0, rho = -Inf), 
#                  upper=c(u = 1, rho = Inf))
end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

coef(m3_u_exp_fit_15)

saveRDS(m3_u_exp_fit_15, file = here("mle","susc","m3_u_exp_fit_alt_15.rds"))


tmp <- exp_data %>% filter(temp %in% temp_IDs[2])
m3_u_exp_fit_20 <- mle2(m3_rho_ll, start=list(u = 0.0001,
                                   rho = -0.1), 
                     control=list(parscale = c(u = 0.0001,
                                   rho = -0.1)),
                     skip.hessian=F, method="Nelder-Mead")

# m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.000001,
#                                    rho = 0.05), 
#                      control=list(parscale = c(u = 0.000001,
#                                    rho = 0.05)),
#                      skip.hessian=F, method="L-BFGS-B", 
#                  lower=c(u = 0, rho = -Inf), 
#                  upper=c(u = 1, rho = Inf))
end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

coef(m3_u_exp_fit_20)

saveRDS(m3_u_exp_fit_20, file = here("mle","susc","m3_u_exp_fit_alt_20.rds"))


tmp <- exp_data %>% filter(temp %in% temp_IDs[3])
m3_u_exp_fit_25 <- mle2(m3_rho_ll, start=list(u = 0.0001,
                                   rho = -0.1), 
                     control=list(parscale = c(u = 0.0001,
                                   rho = -0.1)),
                     skip.hessian=F, method="Nelder-Mead")

# m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.000001,
#                                    rho = 0.05), 
#                      control=list(parscale = c(u = 0.000001,
#                                    rho = 0.05)),
#                      skip.hessian=F, method="L-BFGS-B", 
#                  lower=c(u = 0, rho = -Inf), 
#                  upper=c(u = 1, rho = Inf))
end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

getAIC(m3_u_exp_fit_15) + getAIC(m3_u_exp_fit_20) + getAIC(m3_u_exp_fit_25)

coef(m3_u_exp_fit_25)

saveRDS(m3_u_exp_fit_25, file = here("mle","susc","m3_u_exp_fit_alt_25.rds"))
```


# Full Model

Here, we incorporate both temperature and resource effects on u


$$
proportion\ infected = spores\ consumed \cdot ue^{T_{A}(1/T_{R}-1/T)} e^{R\rho}\\
$$

testing area
```{r, eval=F}
u <- 0.00001
arr_t_u <- 10
rho <- -0.01

  exp_data %<>% mutate(I_end = spores_consumed*u*exp(arr_t_u*(1/ref_t - 1/temp))*exp(resource*rho))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
```


```{r}
m4_ll <- function(u, arr_t_u, rho){

  exp_data %<>% mutate(I_end = spores_consumed*u*
                         exp(arr_t_u*(1/ref_t - 1/temp))*
                         exp(resource*rho))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m4_u_fit <- mle2(m4_ll, start=list(u = 0.00001, 
                                     arr_t_u=10, 
                                     rho=-0.01), 
                     control=list(parscale = c(u = 0.00001, 
                                     arr_t_u=10, 
                                     rho=-0.01)),
                     skip.hessian=F, method="Nelder-Mead")

# m4_u_fit <- mle2(m4_ll, start=list(u = 0.000001, 
#                                      arr_t_u=10, 
#                                      rho=-0.1), 
#                      control=list(parscale = c(u = 0.000001, 
#                                      arr_t_u=10, 
#                                      rho=-0.1)),
#                      skip.hessian=F, method="L-BFGS-B", 
#                    lower=c(u = 0, 
#                            arr_t_f = 0, 
#                            rho = -Inf), 
#                    upper=c(u = Inf, 
#                            arr_t_f = Inf, 
#                            rho = Inf))
end_time <- Sys.time()
m4_runtime <- end_time - start_time
m4_runtime

coef(m4_u_fit)

saveRDS(m4_u_fit, file = here("mle","susc","m4_u_rho_fit_alt.rds"))
```


We try it again here but use exponential function of temperature instead of Arrhenius equation

```{r}
m4a_ll <- function(u, phi, rho){

  exp_data %<>% mutate(I_end = spores_consumed*u*
                         exp(phi*temp)*
                         exp(resource*rho))
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(phi)
  print(rho)
  
  return(nll_sum)
}
```

```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m4a_u_fit <- mle2(m4a_ll, start=list(u = 0.00001, 
                                     phi=0.1, 
                                     rho=-0.01), 
                     control=list(parscale = c(u = 0.00001, 
                                     phi=0.1, 
                                     rho=-0.01)),
                     skip.hessian=F, method="Nelder-Mead")

end_time <- Sys.time()
m4_runtime <- end_time - start_time
m4_runtime

coef(m4a_u_fit)

saveRDS(m4a_u_fit, file = here("mle","susc","m4a_u_rho_fit_alt.rds"))
```



# Fits

Read in the fits here
```{r}
m1_u_fit <- readRDS(here("mle", "susc", "m1_u_fit_alt.rds"))
m2_u_fit <- readRDS(here("mle", "susc", "m2_u_fit_alt.rds"))
m2a_u_fit <- readRDS(here("mle", "susc", "m2a_u_fit_alt.rds"))
m2_u_fits <- readRDS(here("mle", "susc", "m2_u_fits_alt.rds"))
m3_u_fits <- readRDS(here("mle", "susc", "m3_u_fits_alt.rds"))
m3_u_exp_fit <- readRDS(here("mle", "susc", "m3_u_exp_fit_alt.rds"))
m3_u_exp_fit_15 <- readRDS(here("mle", "susc", "m3_u_exp_fit_alt_15.rds"))
m3_u_exp_fit_20 <- readRDS(here("mle", "susc", "m3_u_exp_fit_alt_20.rds"))
m3_u_exp_fit_25 <- readRDS(here("mle", "susc", "m3_u_exp_fit_alt_25.rds"))
m4_u_fit <- readRDS(here("mle", "susc", "m4_u_rho_fit_alt.rds"))
m4a_u_fit <- readRDS(here("mle", "susc", "m4a_u_rho_fit_alt.rds"))
```

AIC
```{r}
getAIC(m1_u_fit)
```


```{r}
getAIC(m2_u_fit)
getAIC(m2a_u_fit)
sum(getAIC(m2_u_fits[[1]]) + getAIC(m2_u_fits[[2]]) + getAIC(m2_u_fits[[3]]))
```


```{r}
sum(getAIC(m3_u_fits[[1]]) + getAIC(m3_u_fits[[2]]) + getAIC(m3_u_fits[[3]]))
sum(getAIC(m3_u_exp_fit_15) + getAIC(m3_u_exp_fit_20) + getAIC(m3_u_exp_fit_25))
getAIC(m3_u_exp_fit)
```


```{r}
getAIC(m4_u_fit)
getAIC(m4a_u_fit)
```


```{r}
getAIC(best_f)
```


# compare to data

get actual infection data to compare the model results to
```{r}
prevalence <- readRDS(here("processed_data", "prevalence.rds"))
prevalence %<>% filter(temp %in% c(15, 20, 25)) %>% filter(species=="D") %>% mutate(ID = paste(temp, resource, sep="_")) %>% dplyr::select(-c(temp, resource, species))

life_summ <- exp_data %>% 
  group_by(treatment, spores_consumed, resource, temp) %>% 
  summarize(n_inf = sum(inf),
            n_total = n())

life_summ %<>% mutate(ID = treatment) %>% left_join(., prevalence, by = "ID") %>% left_join(., length_summ)
```


# these generate the data from the models for the specific experiment conditions

```{r}
m1_u <- coef(m1_u_fit)

m2_u <- coef(m2_u_fit)[1]
m2_arr <- coef(m2_u_fit)[2]

m2a_u <- coef(m2a_u_fit)[1]
m2a_phi <- coef(m2a_u_fit)[2]

m3_u <- coef(m3_u_exp_fit)[1]
m3_rho <- coef(m3_u_exp_fit)[2]

m4_u <- coef(m4_u_fit)[1]
m4_arr <- coef(m4_u_fit)[2]
m4_rho <- coef(m4_u_fit)[3]

m4a_u <- coef(m4_u_fit)[1]
m4a_phi <- coef(m4_u_fit)[2]
m4a_rho <- coef(m4_u_fit)[3]

life_summ %<>% mutate(rate = (f_est/life_vol*exp(arr_f_est*(1/ref_t - 1/temp))*(life_mm^gamma))/
                (1+f_est/life_vol*exp(arr_f_est*(1/ref_t - 1/temp))*(life_mm^gamma)*h_est*exp(temp*w_est)*resource))

life_summ %<>% mutate(m1_end = spores_consumed*m1_u,
                      m2_end = spores_consumed*m2_u*exp(m2_arr*(1/ref_t - 1/temp)),
                      m2a_end = spores_consumed*m2a_u*exp(m2a_phi*temp),
                      m3_end = spores_consumed*m3_u*exp(resource*m3_rho),
                      m4_end = spores_consumed*m4_u*exp(m4_arr*(1/ref_t - 1/temp))*exp(resource*m4_rho),
                      m4a_end = spores_consumed*m4a_u*exp(m4a_phi*temp)*exp(resource*m4a_rho))


life_summ %<>% mutate(m1_susc = m1_u,
                      m2_susc = m2_u*exp(m2_arr*(1/ref_t - 1/temp)),
                      m2a_susc = m2a_u*exp(m2a_phi*temp),
                      m3_susc = m3_u*exp(resource*m3_rho),
                      m4_susc = m4_u*exp(m4_arr*(1/ref_t - 1/temp))*exp(resource*m4_rho),
                      m4a_susc = m4a_u*exp(m4a_phi*temp)*exp(resource*m4a_rho))
```

```{r}
m2_u_15 <- coef(m2_u_fits[[1]])[1]
m2_u_20 <- coef(m2_u_fits[[2]])[1]
m2_u_25 <- coef(m2_u_fits[[3]])[1]

life_summ %<>% mutate(m2_per_end = case_when(temp==15 ~ spores_consumed*m2_u_15,
                                             temp == 20 ~ spores_consumed*m2_u_20,
                                             temp == 25 ~ spores_consumed*m2_u_25))

life_summ %<>% mutate(m2_per_susc = case_when(temp==15 ~ m2_u_15,
                                              temp==20 ~ m2_u_20,
                                              temp==25 ~ m2_u_25))
```



```{r}
m3_u_15 <- coef(m3_u_exp_fit_15)[1]
m3_rho_15 <- coef(m3_u_exp_fit_15)[2]

m3_u_20 <- coef(m3_u_exp_fit_20)[1]
m3_rho_20 <- coef(m3_u_exp_fit_20)[2]

m3_u_25 <- coef(m3_u_exp_fit_25)[1]
m3_rho_25 <- coef(m3_u_exp_fit_25)[2]

life_summ %<>% mutate(m3_per_end = case_when(temp==15 ~ spores_consumed*m3_u_15*exp(resource*m3_rho_15),
                                             temp == 20 ~ spores_consumed*m3_u_20*exp(resource*m3_rho_20),
                                             temp == 25 ~ spores_consumed*m3_u_25*exp(resource*m3_rho_25)))

life_summ %<>% mutate(m3_per_susc = case_when(temp==15 ~ m3_u_15*exp(resource*m3_rho_15),
                                             temp == 20 ~ m3_u_20*exp(resource*m3_rho_20),
                                             temp == 25 ~ m3_u_25*exp(resource*m3_rho_25)))
```

# visualizations

```{r}
life_summ %>% ggplot(.,aes(x=resource, y=spores_consumed, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="spores_consumed")
```

### constant u prevalence
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m1_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="independent model")
```


### temperature-dependent prevalence
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m2_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="temp model")

life_summ %>% ggplot(.,aes(x=resource, y=m2a_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="temp model")

life_summ %>% ggplot(.,aes(x=resource, y=m2_per_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="temp model")
```

### resource-dependent prevalence
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m3_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="resource model")

life_summ %>% ggplot(.,aes(x=resource, y=m3_per_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="resource model")
```

### temp and resource-dependent prevalence

```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m4_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="full model")

life_summ %>% ggplot(.,aes(x=resource, y=m4a_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="full model")

```


### constant u

```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m1_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="independent model")
```

### temperature-dependent u
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m2_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="temp model")

life_summ %>% ggplot(.,aes(x=resource, y=m2a_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="temp model")

life_summ %>% ggplot(.,aes(x=resource, y=m2_per_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="temp model")

```

### resource-dependent u
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m3_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="resource model")

life_summ %>% ggplot(.,aes(x=resource, y=m3_per_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="resource model")
```

### temp and resource-dependent u
```{r}
life_summ %>% ggplot(.,aes(x=resource, y=m4_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="full model")

life_summ %>% ggplot(.,aes(x=resource, y=m4a_susc, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + labs(title="full model")

```




