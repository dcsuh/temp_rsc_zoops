---
title: "u_f_fits"
output: html_document
date: "`r Sys.Date()`"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
library(here)
source(here("base","src.R"))

library(ggnewscale)
```


# Notes

 - this version uses the best fitting f and tries to estiamte u under different formulations
 - each version should use the same u formulation from model 6c which is the full model with an exponential interaction term for the effect of temperature on the resource effect

# Read data and set global params

```{r}
fitness <- read.csv(here("raw_data/main_fitness_edit.csv")) #must be read.csv
fitness %<>% dplyr::select(tube, temp_id, REMOVED, KBP, final_date)
mort <-  read_csv(here("raw_data/main_mort_edit.csv"))
lengths <- read_csv(here("raw_data", "day5_length.csv")) #from life table
lengths %<>% filter(temp_id %in% c(15,20,25))


dataset <- left_join(mort,fitness) #life table data

data <- readRDS(here("processed_data","foraging_raw.rds")) #foraging rate assay
data_summ <- readRDS(here("processed_data", "foraging.rds")) #foraging rate assay summary

data %<>% mutate(treatment_ID = paste(temp, resource, sep = "_"))

data %<>% mutate(resource_tot = resource*vol) #resource_tot is the total amount of resources in our tube. resource concentration * total volume of tube 

treatment_IDs <- unique(data$treatment_ID)
resource_IDs <- unique(data$resource)
temp_IDs <- unique(data$temp)


fora_vol <- 15 #mL
life_vol <- 50 #mL
spore_conc <- 200 #spores/mL
gamma <- 2 
ref_t <- 15 #celsius

```

Dataset are the data from the life table experiment
Requires a bit of cleaning
```{r}
dataset %<>% filter(species == "D") %>% #only daphnia for this analysis
  filter(temp %in% const_temp) #only constant temp for this analysis

dataset %<>% mutate(birthdate = ifelse(species == "daphnia", "4/5/22", "4/6/22"), 
                    lifespan = as.numeric(mdy(final_date) - mdy(birthdate)),
                    temp = as.numeric(temp),
                    treatment = paste(temp, resource, sep = "_")) %>% 
  filter(is.na(male)) %>% #remove males
  filter(is.na(missing)) %>% #remove missing
  filter(!is.na(inf)) #remove NAs for inf for estimating beta. sometimes they died too young to tell

dataset %<>% mutate(inf_status = inf, dead = ifelse(is.na(REMOVED) & is.na(KBP), 1, 0))


dataset %<>% mutate(spore_exposure = 200, #spores/mL
                    uninf = 1-inf_status,
                    time = 1, #duration of exposure in days
                    trt = paste(temp, resource, species, sep = "_"))
```

We use average lengths later on. We need to use averages because we weren't able to measure length for every individual.
For the foraging rate assay, these are the actual lengths because we measured the length of each individual at the end of the assay.

For the life table data, these are the lengths of a representative number of individuals right before the rest were exposed to spores. We take an average for these lengths since we didn't have length data for every individual.

```{r}
lengths %<>% mutate(mm = raw_meas*17.86/1000)
#at default magnification (5.6x), 1 unit is equal to 17.86 micron

length_summ <- lengths %>% 
  group_by(temp_id, resource) %>% 
  summarize(life_mm = mean(mm),
            var = var(mm),
            sd = sd(mm),
            se = sd(mm)/sqrt(n())) %>%
  ungroup() %>%
  dplyr::select(temp_id, resource, life_mm)

length_summ %<>% add_row(temp_id=as.character(25), resource=as.numeric(0.5), life_mm=1.16) #midpoint between 1.0 and 0.1
```

Join length data to both dataframes
Some of the length data from the foraging rate assay are missing so we impute these values from the averages from the data we do have.
We were also missing length data for one treatment from the life table so we use the foraging rate data lengths to replace those as well.

```{r}
dataset %<>% left_join(length_summ)

length_summ %<>% mutate(ID = paste(temp_id, resource, sep="_")) %>% dplyr::select(-c(temp_id, resource))


mean_length_summ <- data_summ %>% dplyr::select(temp, resource, mm_mean)
data %<>% left_join(., mean_length_summ)
data %<>% mutate(mm = if_else(!is.na(mm), mm, mm_mean))

mean_length_summ %<>% rename(fora_mm = "mm_mean")
dataset %<>% left_join(., mean_length_summ)
```


```{r}
m6c <- readRDS(here("mle","m6c_f_fit.rds")) # EXP-EXP

m6c_coef <- coef(m6c)

f_est <- m6c_coef[1]
arr_f_est <- m6c_coef[2]
h_est <- m6c_coef[3]
w_est <- m6c_coef[4]
```



# ```{r}
# m6c_quantiles <- readRDS(file = here("mle", "m6c_quantiles.rds"))
# 
# f_est <- m6c_quantiles$f[1]
# f_lower <- m6c_quantiles$f[3]
# f_upper <- m6c_quantiles$f[4]
# 
# arr_f_est <- m6c_quantiles$arr[1]
# arr_f_lower <- m6c_quantiles$arr[3]
# arr_f_upper <- m6c_quantiles$arr[4]
# 
# h_est <- m6c_quantiles$h[1]
# h_lower <- m6c_quantiles$h[3]
# h_upper <- m6c_quantiles$h[4]
# 
# w_est <- m6c_quantiles$w[1]
# w_lower <- m6c_quantiles$w[3]
# w_upper <- m6c_quantiles$w[4]
# ```



# Independent Model

This model assumes constant f and constant u for all treatments

$$
\frac{dR}{dt} = -L^{\gamma} fRS\\
$$

We end up using this system of equations for everything and modify it by modifying how parameters are written out in the solver chunk.

```{r}
m1_num_sol <- function(t, x, params){
  R <- x[1]
  S <- x[2]
  I <- x[3]
  Z <- x[4]
  with(as.list(params),{
    dR <- -f*R*(S+I)
    dS <- -u*f*Z*S
    dI <- u*f*Z*S
    dZ <- -f*Z*(S+I)
    res <- c(dR, dS, dI, dZ)
    list(res)}
    )
}
```

```{r}
m1_sim <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u)
  
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  if(Z == 0) {
  end_data <- slice_max(output, time)[,2]
  }
  else {
  end_data <- slice_max(output, time)[,4]  
  }
  
  # r_end <- ifelse(r_end<0, 0, r_end) #ensure that final resource concentration is never negative
  #probably unnecessary
  return(end_data)
}
```

```{r, m1_ll}
m1_ll <- function(f, u, arr_t_f, h, w){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m1_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f/life_vol, 
                                u=u, 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_t_f,
                                h = h*exp(exp_data$temp*w),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(f)
  print(u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m1_u_fit <- mle2(m1_ll, start=list(u = 0.001, 
                                   f=f_est, 
                                   arr_t_f=arr_f_est,
                                   h=h_est,
                                   w=w_est), 
                     control=list(parscale = c(u = 0.001, 
                                               f=f_est, 
                                               arr_t_f=arr_f_est,
                                               h=h_est,
                                               w=w_est)),
                     skip.hessian=F, method="L-BFGS-B", 
                 lower=c(u = 0, 
                         f = f_lower,
                         arr_t_f = arr_f_lower,
                         h = h_lower,
                         w = w_lower), 
                 upper=c(u = 1, 
                         f = f_upper,
                         arr_t_f = arr_f_upper,
                         h = h_upper,
                         w = w_upper))
end_time <- Sys.time()
m1_runtime <- end_time - start_time
m1_runtime

coef(m1_u_fit)

saveRDS(m1_u_fit, file = here("mle","susc","m1_u_fit.rds"))
```

Always results in convergence failure

```{r, m1_ll}
m1_ll <- function(u){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m1_sim, 
                                R=exp_data$resource*life_vol, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u, 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                h = h_est*exp(exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m1_u_fit <- mle2(m1_ll, start=list(u = 0.000001), 
                     control=list(parscale = c(u = 0.000001)),
                     skip.hessian=F, method="L-BFGS-B", 
                 lower=c(u = 0), 
                 upper=c(u = 1))
end_time <- Sys.time()
m1_runtime <- end_time - start_time
m1_runtime

coef(m1_u_fit)

saveRDS(m1_u_fit, file = here("mle","susc","m1_u_fit.rds"))
```




# Temperature-Dependent Model

This model includes an Arrhenius function to modify f and u separately as a function of temperature.


$$
\frac{dR}{dt} = -L^{\gamma}fe^{T_{A}(1/T_{R}-1/T)} RS\\  
$$


```{r}
m2_sim <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u*exp(arr_t_u*(1/ref_t - 1/temp)))
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  if(Z == 0) {
  end_data <- slice_max(output, time)[,2]
  }
  else {
  end_data <- slice_max(output, time)[,4]  
  }
  
  # r_end <- ifelse(r_end<0, 0, r_end) #ensure that final resource concentration is never negative
  #probably unnecessary
  return(end_data)
}
```

```{r}
m2_ll <- function(u, arr_t_u){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m2_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u, 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u,
                                h = h_est*exp(exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  # print(u)
  # print(arr_t_u)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m2_u_fit <- mle2(m2_ll, start=list(u = 0.000001,
                                   arr_t_u = 10), 
                     control=list(parscale = c(u = 0.000001,
                                   arr_t_u = 10)),
                     skip.hessian=F, method="L-BFGS-B", 
                 lower=c(u = 0, arr_t_u = 0), 
                 upper=c(u = 1, arr_t_u = Inf))
end_time <- Sys.time()
m2_runtime <- end_time - start_time
m2_runtime

coef(m2_u_fit)

saveRDS(m2_u_fit, file = here("mle","susc","m2_u_fit.rds"))
```


# Resource-dependent Model

u per resource and u with exponential function for resource

u per resource treatment

```{r}
m3_sim <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u)
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  if(Z == 0) {
  end_data <- slice_max(output, time)[,2]
  }
  else {
  end_data <- slice_max(output, time)[,4]  
  }
  
  # r_end <- ifelse(r_end<0, 0, r_end) #ensure that final resource concentration is never negative
  #probably unnecessary
  return(end_data)
}
```

```{r}
m3u_ll <- function(u_low, u_med, u_high){

  
  nll_sum <- 0  
  u_nll <- 0
  u_vec <- c(u_low, u_med, u_high)
  for(j in 1:length(resource_IDs)){  
    
      exp_data <- dataset %>% filter(exposed==TRUE)
      exp_data %<>% filter(resource == resource_IDs[j])
      
      
      I_end <- as.data.frame(mapply(m3_sim, 
                                    R=exp_data$resource*life_vol/1000, 
                                    time=exp_data$time, 
                                    f=f_est/life_vol, 
                                    u=u_vec[j], 
                                    length = exp_data$life_mm, 
                                    gamma=gamma, 
                                    Z=spore_conc*life_vol,
                                    ref_t = ref_t,
                                    arr_t_f = arr_f_est,
                                    h = h_est*exp(exp_data$temp*w_est),
                                    temp=exp_data$temp))
    
      colnames(I_end) <- "I_end"
      
      exp_data %<>% cbind(I_end)
      
        inf_out <- function(inf_status, I_end){
        dbinom(x = inf_status, size = 1, prob=I_end, log=T)
        }
        
      exp_data %<>% 
        mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
      u_nll <- u_nll + -sum(exp_data$ll)
  }
  
  print(paste(u_low, u_med, u_high, sep ="_"))  

  nll_sum <- nll_sum + u_nll
  return(nll_sum)
}
```


Now we use the optimizer
```{r, eval=F}
start_time <- Sys.time()
tmp <- data

u_vec <- c(0.00001,#pass
           0.00001,#pass
           0.00001)#not working

m3_u_per_fit <- mle2(m3u_ll, start=list(u_low = u_vec[1],
                                       u_med = u_vec[2],
                                       u_high = u_vec[3]), 
                     control=list(parscale = c(u_low = u_vec[1],
                                       u_med = u_vec[2],
                                       u_high = u_vec[3])),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u_low = 0,
                           u_med = 0,
                           u_high = 0), 
                   upper=c(u_low = 1,
                           u_med = 1,
                           u_high = 1))
end_time <- Sys.time()
m3u_runtime <- end_time - start_time
m3u_runtime

coef(m3_u_per_fit)

saveRDS(m3_u_per_fit, file = here("mle","susc","m3_u_per_fit.rds"))
```




```{r}
m3_rho_ll <- function(u, rho){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m3_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*rho), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                h = h_est*exp(exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(rho)
  
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m3_u_exp_fit <- mle2(m3_rho_ll, start=list(u = 0.00001,
                                   rho = 0.001), 
                     control=list(parscale = c(u = 0.00001,
                                   rho = 0.001)),
                     skip.hessian=F, method="L-BFGS-B", 
                 lower=c(u = 0, rho = -Inf), 
                 upper=c(u = 1, rho = Inf))
end_time <- Sys.time()
m3_runtime <- end_time - start_time
m3_runtime

coef(m3_u_exp_fit)

saveRDS(m3_u_exp_fit, file = here("mle","susc","m3_u_exp_fit.rds"))
```


# Full Model

This version uses an arrhenius function for both f and u and a handling time function for f only.

$$
\frac{dR}{dt} = -\frac{fe^{T_{A}(1/T_{R}-1/T)} L^{\gamma}R}{1 + fe^{T_{A}(1/T_{R}-1/T)}hL^{\gamma}R} S \\
$$

```{r}
m4_sim <- function(R, time, f, u, length, gamma, Z, ref_t, arr_t_f, arr_t_u, h, temp){
  times <- seq(0, time, by=0.01)
  xstart <- c(R=R,
              S=1,
              I=0,
              Z=Z)
  params <- c(f=(f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma))/
                (1+f*exp(arr_t_f*(1/ref_t - 1/temp))*(length^gamma)*h*R),
              u=u*exp(arr_t_u*(1/ref_t - 1/temp)))
  output <- as.data.frame(lsoda(y=xstart, times, m1_num_sol, params))
  if(Z == 0) {
  end_data <- slice_max(output, time)[,2]
  }
  else {
  end_data <- slice_max(output, time)[,4]  
  }
  
  # r_end <- ifelse(r_end<0, 0, r_end) #ensure that final resource concentration is never negative
  #probably unnecessary
  return(end_data)
}
```

```{r}
m4_ll <- function(u, arr_t_u, rho){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m4_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*rho), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u,
                                h = h_est*exp(exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  
  return(nll_sum)
}
```




```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m4_u_fit <- mle2(m4_ll, start=list(u = 0.00001, 
                                     arr_t_u=10, 
                                     rho=0.1), 
                     control=list(parscale = c(u = 0.00001, 
                                     arr_t_u=10, 
                                     rho=0.1)),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                           arr_t_f = 0, 
                           rho = -Inf), 
                   upper=c(u = Inf, 
                           arr_t_f = Inf, 
                           rho = Inf))
end_time <- Sys.time()
m4_runtime <- end_time - start_time
m4_runtime

coef(m4_u_fit)

saveRDS(m4_u_fit, file = here("mle","susc","m4_u_rho_fit.rds"))
```






# Model 5 - Resource on temperature interaction

Same as model 4 but we include a linear interaction term for the arrhenius coefficient, thus representing the interactive effect of resources on the temperature effect


```{r}
m5a_ll <- function(u, arr_t_u, rho, p_u){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m4_sim, 
                                R=exp_data$resource*life_vol, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*rho), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u + p_u*exp_data$resource,
                                h = (h_est + exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  print(p_u)
  
  return(nll_sum)
}
```

```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m5a_u_fit <- mle2(m5a_ll, start=list(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     p_u = 1), 
                     control=list(parscale = c(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     p_u = 1)),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                           arr_t_f = 0, 
                           rho = -Inf,
                           p_u = -Inf), 
                   upper=c(u = Inf, 
                           arr_t_f = Inf, 
                           rho = Inf,
                           p_u = Inf))
end_time <- Sys.time()
m5a_runtime <- end_time - start_time
m5a_runtime

coef(m5a_u_fit)

saveRDS(m5a_u_fit, file = here("mle","susc","m5a_u_rho_fit.rds"))
```



```{r}
m5b_ll <- function(u, arr_t_u, rho, p_u){

  exp_data <- dataset %>% filter(exposed==TRUE)

  
  I_end <- as.data.frame(mapply(m4_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*rho), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u*exp(p_u*exp_data$resource),
                                h = (h_est + exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  print(p_u)
  
  return(nll_sum)
}
```

```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m5b_u_fit <- mle2(m5a_ll, start=list(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     p_u = 0.01), 
                     control=list(parscale = c(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     p_u = 0.01)),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                           arr_t_f = 0, 
                           rho = -Inf,
                           p_u = -Inf), 
                   upper=c(u = Inf, 
                           arr_t_f = Inf, 
                           rho = Inf,
                           p_u = -Inf))
end_time <- Sys.time()
m5b_runtime <- end_time - start_time
m5b_runtime

coef(m5b_u_fit)

saveRDS(m5b_u_fit, file = here("mle","susc","m5b_u_rho_fit.rds"))
```




```{r}
m5u_per_ll <- function(u, arr_low, arr_med, arr_high){

  
  nll_sum <- 0  
  u_nll <- 0
  arr_vec <- c(arr_low, arr_med, arr_high)
  for(j in 1:length(resource_IDs)){  
    
      exp_data <- dataset %>% filter(exposed==TRUE)
      exp_data %<>% filter(resource == resource_IDs[j])
      
      
      I_end <- as.data.frame(mapply(m4_sim, 
                                    R=exp_data$resource*life_vol/1000, 
                                    time=exp_data$time, 
                                    f=f_est/life_vol, 
                                    u=u, 
                                    length = exp_data$life_mm, 
                                    gamma=gamma, 
                                    Z=spore_conc*life_vol,
                                    ref_t = ref_t,
                                    arr_t_f = arr_f_est,
                                    arr_t_u = arr_vec[j],
                                    h = (h_est + exp_data$temp*w_est),
                                    temp=exp_data$temp))
    
      colnames(I_end) <- "I_end"
      
      exp_data %<>% cbind(I_end)
      
        inf_out <- function(inf_status, I_end){
        dbinom(x = inf_status, size = 1, prob=I_end, log=T)
        }
        
      exp_data %<>% 
        mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
      u_nll <- u_nll + -sum(exp_data$ll)
  }
  
  print(u)
  print(paste(arr_low, arr_med, arr_high, sep ="_"))  

  nll_sum <- nll_sum + u_nll
  return(nll_sum)
}
```


```{r, eval=F}
start_time <- Sys.time()

arr_vec <- c(10,
             10,
             10)

tmp <- data
m5u_per_fit <- mle2(m5u_per_ll, start=list(u = 0.0001, 
                                     arr_low = arr_vec[1],
                                     arr_med = arr_vec[2],
                                     arr_high = arr_vec[3]), 
                     control=list(parscale = c(u = 0.0001, 
                                     arr_low = arr_vec[1],
                                     arr_med = arr_vec[2],
                                     arr_high = arr_vec[3])),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                                     arr_low = 0,
                                     arr_med = 0,
                                     arr_high = 0), 
                   upper=c(u = 1, 
                                     arr_low = Inf,
                                     arr_med = Inf,
                                     arr_high = Inf))
end_time <- Sys.time()
m5_per_runtime <- end_time - start_time
m5_per_runtime

coef(m5u_per_fit)

saveRDS(m5u_per_fit, file = here("mle","susc","m5u_per_fit.rds"))
```


# Model 6 - Temperature on Resource interaction

Same as model 4 with a linear interaction for how exponential resource effect is affected by temperature, thus incorporating an interactive effect of temperature on the resource effect.


```{r}
m6a_ll <- function(u, arr_t_u, rho, w){

  exp_data <- dataset %>% filter(exposed==TRUE)
  
  I_end <- as.data.frame(mapply(m4_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*(rho + exp(exp_data$temp*w))), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u,
                                h = (h_est + exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  print(w)
  
  return(nll_sum)
}
```




```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m6a_u_fit <- mle2(m6a_ll, start=list(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     w=0.01), 
                     control=list(parscale = c(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     w=0.01)),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                           arr_t_f = 0, 
                           rho = -Inf,
                           w = -Inf), 
                   upper=c(u = Inf, 
                           arr_t_f = Inf, 
                           rho = Inf,
                           w = Inf))
end_time <- Sys.time()
m6a_runtime <- end_time - start_time
m6a_runtime

coef(m6a_u_fit)

saveRDS(m6a_u_fit, file = here("mle","susc","m6a_u_rho_fit.rds"))
```


```{r}
m6b_ll <- function(u, arr_t_u, rho, w){

  exp_data <- dataset %>% filter(exposed==TRUE)
  
  I_end <- as.data.frame(mapply(m4_sim, 
                                R=exp_data$resource*life_vol/1000, 
                                time=exp_data$time, 
                                f=f_est/life_vol, 
                                u=u*exp(exp_data$resource*(rho + exp(exp_data$temp*w))), 
                                length = exp_data$life_mm, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = arr_t_u,
                                h = (h_est + exp_data$temp*w_est),
                                temp=exp_data$temp))

  colnames(I_end) <- "I_end"
  
  exp_data %<>% cbind(I_end)
  
    inf_out <- function(inf_status, I_end){
    dbinom(x = inf_status, size = 1, prob=I_end, log=T)
  }
  
  exp_data %<>% 
    mutate(ll = mapply(inf_out, inf_status = inf_status, I_end=I_end))
  nll_sum <- -sum(exp_data$ll)
  
  print(u)
  print(arr_t_u)
  print(rho)
  print(w)
  
  return(nll_sum)
}
```




```{r, eval=F}
start_time <- Sys.time()
tmp <- data
m6b_u_fit <- mle2(m6b_ll, start=list(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     w=0.01), 
                     control=list(parscale = c(u = 0.0001, 
                                     arr_t_u=10, 
                                     rho=0.01,
                                     w=0.01)),
                     skip.hessian=F, method="L-BFGS-B", 
                   lower=c(u = 0, 
                           arr_t_f = 0, 
                           rho = -Inf,
                           w = -Inf), 
                   upper=c(u = Inf, 
                           arr_t_f = Inf, 
                           rho = Inf,
                           w = Inf))
end_time <- Sys.time()
m6b_runtime <- end_time - start_time
m6b_runtime

coef(m6b_u_fit)

saveRDS(m6b_u_fit, file = here("mle","susc","m6b_u_rho_fit.rds"))
```

# Model 7 - Full interaction

Full interaction model where both temperature and resources effects are functions of each other.

Model 7a is linear interaction terms


```{r}
m1_u_fit <- readRDS(file = here("mle", "susc", "m1_u_fit.rds"))
m2_u_fit <- readRDS(file = here("mle", "susc", "m2_u_fit.rds"))
m3_u_per_fit <- readRDS(file = here("mle", "susc", "m3_u_per_fit.rds"))
m3_u_exp_fit <- readRDS(file = here("mle", "susc", "m3_u_exp_fit.rds"))
m4_u_fit <- readRDS(file = here("mle", "susc", "m4_u_rho_fit.rds"))
# m5a_u_fit <- readRDS(file = here("mle", "susc", "m5a_u_rho_fit.rds"))
# m5b_u_fit <- readRDS(file = here("mle", "susc", "m5b_u_rho_fit.rds"))
m5u_per_fit <- readRDS(file = here("mle", "susc", "m5u_per_fit.rds"))
```


```{r}
getAIC <- function(model){
  return(2*length(coef(model))-(2*summary(model)@m2logL/-2))
}
```

```{r}
getAIC(m1_u_fit)
getAIC(m2_u_fit)
getAIC(m3_u_per_fit)
getAIC(m3_u_exp_fit)
getAIC(m4_u_fit)
# getAIC(m5a_u_fit)
# getAIC(m5b_u_fit)
getAIC(m5u_per_fit)
```


```{r}
getAIC(m6c)
getAIC(m6c) + getAIC(m2_u_fit)
```

















```{r}
fora_summ <- data %>% 
  mutate(ID = treatment_ID) %>%
  group_by(ID) %>% 
  summarize(end_r_mean = mean(amt_rem)*fora_vol/1000,
            end_r_se = (sd(amt_rem)/sqrt(n()))*fora_vol/1000)

prevalence <- readRDS(here("processed_data", "prevalence.rds"))
prevalence %<>% filter(temp %in% c(15, 20, 25)) %>% filter(species=="D") %>% mutate(ID = paste(temp, resource, sep="_")) %>% dplyr::select(-c(temp, resource, species))


viz_summ <- left_join(fora_summ, prevalence)
viz_summ %<>% left_join(., data_summ)
viz_summ %<>% left_join(., length_summ)
```

# need to check these units

```{r}


f_mod <- f_est
h_mod <- h_est

data_summ %<>% mutate(clearance = 
                        (f_mod*exp(arr_f_est*(1/ref_t - 1/temp)))/
                        (1+f_est*exp(arr_f_est*(1/ref_t - 1/temp))*(h_mod*exp(w_est*temp))*resource/15))


```


```{r}
m1_coef <- coef(m1_u_fit)
m1_u <- as.numeric(m1_coef[1])

data_summ %<>% mutate(m1_u = m1_u)
```


```{r}
m2_coef <- coef(m2_u_fit)
m2_u <- as.numeric(m2_coef[1])
m2_arr_u <- as.numeric(m2_coef[2])

data_summ %<>% mutate(m2_u = m2_u*exp(m2_arr_u*(1/ref_t - 1/temp)))
```

```{r}
m3_per_coef <- coef(m3_u_per_fit)

m3_u_low <- as.numeric(m3_per_coef[1])
m3_u_med <- as.numeric(m3_per_coef[2])
m3_u_high <- as.numeric(m3_per_coef[3])

data_summ %<>% mutate(m3_u = case_when(resource==0.1 ~ m3_u_low,
                                       resource==0.5 ~ m3_u_med,
                                       resource==1 ~ m3_u_high,))
```

```{r}
m3_coef <- coef(m3_u_exp_fit)

m3_u <- as.numeric(m3_coef[1])
m3_rho <- as.numeric(m3_coef[2])

data_summ %<>% mutate(m3_u = m3_u*exp(m3_rho*resource))
```


```{r}
m4_coef <- coef(m4_u_fit)

m4_u <- as.numeric(m4_coef[1])
m4_arr_u <- as.numeric(m4_coef[2])
m4_rho <- as.numeric(m4_coef[3])

data_summ %<>% mutate(m4_u = m4_u*exp(m4_arr_u*(1/ref_t - 1/temp))*exp(m4_rho*resource))
```


```{r}
data_summ %<>% mutate(rate_mean_ml_day=rate_len_mean*60*24,
                      rate_se_ml_day=rate_len_mean_se*60*24)
```




```{r}
viz_summ %<>% mutate(m1_I_end = mapply(m1_sim, 
                                R=resource*life_vol/1000, 
                                time=time_mean, 
                                f=f_est/life_vol, 
                                u=m1_u, 
                                length = mm_mean, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                h = h_est*exp(temp*w_est),
                                temp=temp))

```

```{r}
viz_summ %<>% mutate(m2_I_end = mapply(m2_sim, 
                                R=resource*life_vol/1000, 
                                time=time_mean, 
                                f=f_est/life_vol, 
                                u=m2_u, 
                                length = mm_mean, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = m2_arr_u,
                                h = h_est*exp(temp*w_est),
                                temp=temp))

```


```{r}
viz_summ %<>% mutate(m3_per_I_end = mapply(m3_sim, 
                                    R=resource*life_vol/1000, 
                                    time=time_mean, 
                                    f=f_est/life_vol, 
                                    u=case_when(resource==0.1 ~ m3_u_low,
                                                resource==0.5 ~ m3_u_med,
                                                resource==1 ~ m3_u_high), 
                                    length = mm_mean, 
                                    gamma=gamma, 
                                    Z=spore_conc*life_vol,
                                    ref_t = ref_t,
                                    arr_t_f = arr_f_est,
                                    h = h_est*exp(temp*w_est),
                                    temp=temp))
```

```{r}
viz_summ %<>% mutate(m3_I_end = mapply(m3_sim, 
                                    R=resource*life_vol/1000, 
                                    time=time_mean, 
                                    f=f_est/life_vol, 
                                    u=m3_u*exp(m3_rho*resource), 
                                    length = mm_mean, 
                                    gamma=gamma, 
                                    Z=spore_conc*life_vol,
                                    ref_t = ref_t,
                                    arr_t_f = arr_f_est,
                                    h = h_est*exp(temp*w_est),
                                    temp=temp))
```


```{r}
viz_summ %<>% mutate(m4_I_end = mapply(m4_sim, 
                                R=resource*life_vol/1000, 
                                time=time_mean, 
                                f=f_est/life_vol, 
                                u=m4_u*exp(resource*m4_rho), 
                                length = mm_mean, 
                                gamma=gamma, 
                                Z=spore_conc*life_vol,
                                ref_t = ref_t,
                                arr_t_f = arr_f_est,
                                arr_t_u = m4_arr_u,
                                h = h_est*exp(temp*w_est),
                                temp=temp))
```


```{r}
viz_summ %>% ggplot(.,aes(x=resource, y=m1_I_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="independent model")

viz_summ %>% ggplot(.,aes(x=resource, y=m2_I_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="temperature-dependent model")

viz_summ %>% ggplot(.,aes(x=resource, y=m3_per_I_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="resource-dependent model")

viz_summ %>% ggplot(.,aes(x=resource, y=m3_I_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="resource-dependent model")

viz_summ %>% ggplot(.,aes(x=resource, y=m4_I_end, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=prev, color=as.factor(temp)), size=4) + labs(title="full model")


```

```{r}

data_summ %>% ggplot(.,aes(x=resource, y=clearance, color=as.factor(temp))) + geom_point(size = 3, shape=2) +
  new_scale_color() + geom_point(aes(x=resource, y=rate_mean_ml_day, color=as.factor(temp)), size=4) + labs(title="full model")


data_summ %>% ggplot(.,aes(x=resource, y=clearance, color=as.factor(temp))) + geom_point(size = 3, shape=2)
```


```{r, eval=F}
data_summ %>% ggplot(.,aes(x=resource, y=m1_u, color=as.factor(temp))) + geom_point()
data_summ %>% ggplot(.,aes(x=resource, y=m2_u, color=as.factor(temp))) + geom_point()
data_summ %>% ggplot(.,aes(x=resource, y=m3_u, color=as.factor(temp))) + geom_point()
data_summ %>% ggplot(.,aes(x=resource, y=m4_u, color=as.factor(temp))) + geom_point()
```





